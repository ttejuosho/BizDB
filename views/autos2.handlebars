<main role="main">
  <div class="jumbotron">
    <div class="container">
      <h1 class="display-3">Chicago Auctions Database</h1>
      <p>Search Auto Auctions</p>

      <form id="vehicleSearchForm">
        <div class="form-row">
          <div class="col-12 col-lg-10">
            <div id="filtersContainer"></div>

            <div class="form-row mt-2">
              <div class="col-12 col-md-3 mb-2">
                <select id="matchMode" class="form-control">
                  <option value="contains" selected>Match: Contains</option>
                  <option value="startsWith">Match: Starts With</option>
                  <option value="equals">Match: Equals</option>
                </select>
              </div>

              <div class="col-12 col-md-3 mb-2">
                <select id="sortBy" class="form-control">
                  <option value="year" selected>Sort: Year</option>
                  <option value="make">Sort: Make</option>
                  <option value="lotNumber">Sort: Lot Number</option>
                  <option value="itemNumber">Sort: Item Number</option>
                </select>
              </div>

              <div class="col-12 col-md-2 mb-2">
                <select id="sortDir" class="form-control">
                  <option value="DESC" selected>DESC</option>
                  <option value="ASC">ASC</option>
                </select>
              </div>

              <div class="col-12 col-md-2 mb-2">
                <select id="limit" class="form-control">
                  <option value="25">Limit 25</option>
                  <option value="50" selected>Limit 50</option>
                  <option value="100">Limit 100</option>
                  <option value="200">Limit 200</option>
                </select>
              </div>

              <div class="col-12 col-md-2 mb-2">
                <button type="button" class="btn btn-outline-secondary btn-block" id="addFilterBtn">
                  Add Filter
                </button>
              </div>
            </div>

            <div class="form-row mt-2">
              <div class="col-12 col-md-3 mb-2">
                <button type="button" class="btn btn-dark btn-block" id="goSearch">Search</button>
              </div>
              <div class="col-12 col-md-3 mb-2">
                <button type="button" class="btn btn-outline-danger btn-block" id="clearFilters">
                  Clear
                </button>
              </div>
              <div class="col-12 col-md-6 mb-2 d-flex align-items-center">
                <p id="searchInfo" class="mt-2 mb-0"></p>
              </div>
            </div>
          </div>
        </div>
      </form>

      <small class="text-muted d-block mt-2">
        Tip: Use “All (q)” for global search; add additional filters to narrow results.
      </small>
    </div>
  </div>

  <div class="container">
    <div class="row" id="resultsDiv"></div>
    <div hidden id="spinner"></div>
  </div>
</main>

<script type="text/javascript">
  // ----------------------------
  // Configuration
  // ----------------------------
  const FILTER_FIELDS = [
    { value: "q", label: "All (q)" },
    { value: "itemNumber", label: "Item Number" },
    { value: "lotNumber", label: "Lot Number" },
    { value: "year", label: "Year" },
    { value: "make", label: "Make" },
    { value: "modelGroup", label: "Model Group" },
    { value: "modelDetails", label: "Model Details" },
    { value: "bodyStyle", label: "Body Style" },
    { value: "color", label: "Color" },
    { value: "vin", label: "VIN" },
    { value: "locationCity", label: "Location (City)" },
    { value: "locationState", label: "Location (State)" },
    { value: "locationZip", label: "Location (Zip)" },
    { value: "locationCountry", label: "Location (Country)" },
    { value: "trim", label: "Trim" },
  ];

  // If your autocomplete endpoint expects DB column names, map param -> DB column
  const PARAM_TO_COLUMN = {
    itemNumber: "Item_Number",
    lotNumber: "Lot_Number",
    year: "Year",
    make: "Make",
    modelGroup: "Model_Group",
    modelDetails: "Model_Details",
    bodyStyle: "Body_Style",
    color: "Color",
    vin: "VIN",
    locationCity: "Location_City",
    locationState: "Location_State",
    locationZip: "Location_Zip",
    locationCountry: "Location_Country",
    trim: "Trim",
  };

  let filterRowCounter = 0;

  // ----------------------------
  // Helpers: Highlighting + HTML
  // ----------------------------
  function escapeRegExp(s) {
    return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  function highlighter(object1, keywords) {
    const words = (Array.isArray(keywords) ? keywords : [keywords])
      .map((k) => String(k || "").trim())
      .filter(Boolean);

    if (!words.length) return object1;

    for (let [key, value] of Object.entries(object1)) {
      if (value === null || value === undefined) continue;

      let dataPoint = String(value);
      for (const word of words) {
        if (!word) continue;
        if (dataPoint.toLowerCase().includes(word.toLowerCase())) {
          const pattern = new RegExp(escapeRegExp(word), "gi");
          dataPoint = dataPoint.replace(pattern, `<mark>${word}</mark>`);
        }
      }
      object1[key] = dataPoint;
    }
    return object1;
  }

  function appendHTML(vehicle) {
    var html =
      '<div class="col-md-8 mb-5">' +
      "<h3>" +
      vehicle.Year +
      " " +
      vehicle.Make +
      " " +
      vehicle.Model_Details +
      "</h3>" +
      "<hr>" +
      '<p class="mb-1"><img src="http://' +
      vehicle.Image_Thumbnail +
      '" /></p>' +
      '<p class="mb-1"><strong>VIN</strong>: ' +
      vehicle.VIN +
      "</p>" +
      '<p class="mb-1"><strong>Odometer</strong>: ' +
      vehicle.Odometer +
      "</p>" +
      '<p class="mb-1"><strong>Runs/Drive</strong>: ' +
      vehicle.Runs_Drives +
      "</p>" +
      '<p class="mb-1"><strong>Sale Date</strong>: ' +
      vehicle.Sale_Date +
      "</p>" +
      '<p class="mb-1"><strong>Sale Status</strong>: ' +
      vehicle.Sale_Status +
      "</p>" +
      '<p class="mb-1"><strong>Location</strong>: ' +
      vehicle.Location_City +
      ", " +
      vehicle.Location_State +
      ", " +
      vehicle.Location_Zip +
      ", " +
      vehicle.Location_Country +
      "</p>" +
      '<p class="mb-1"><strong>Model</strong>: ' +
      vehicle.Model_Group +
      " " +
      vehicle.Trim +
      "</p>" +
      '<p class="mb-1"><strong>Transmission</strong>: ' +
      vehicle.Transmission +
      "</p>" +
      '<p class="mb-1"><strong>Sale Title State</strong>: ' +
      vehicle.Sale_Title_State +
      "</p>" +
      '<p class="mb-1"><strong>Sale Title Type</strong>: ' +
      vehicle.Sale_Title_Type +
      "</p>" +
      '<p class="mb-1"><strong>Fuel Type</strong>: ' +
      vehicle.Fuel_Type +
      "</p>" +
      '<p class="mb-1"><strong>Body Style</strong>: ' +
      vehicle.Body_Style +
      "</p>" +
      '<p class="mb-1"><strong>Color</strong>: ' +
      vehicle.Color +
      "</p>" +
      '<p class="mb-1"><strong>Has Keys</strong>: ' +
      vehicle.Has_Keys +
      "</p>" +
      '<p class="mb-1"><strong>Damage Description</strong>: ' +
      vehicle.Damage_Description +
      "</p>" +
      '<p class="mb-1"><strong>Secondary Damage</strong>: ' +
      vehicle.Secondary_Damage +
      "</p>" +
      '<p class="mb-1"><strong>Drive</strong>: ' +
      vehicle.Drive +
      "</p>" +
      '<p class="mb-1"><strong>Estimated Retail Value</strong>: $' +
      vehicle.Estimated_Retail_Value +
      "</p>" +
      '<p class="mb-1"><strong>Repair Cost</strong>: $' +
      vehicle.Repair_Cost +
      "</p>" +
      '<p class="mb-1"><strong>Last Updated</strong>: ' +
      vehicle.Last_Updated_Time +
      "</p>" +
      "</div>";

    return html;
  }

  // ----------------------------
  // Filter row creation + selectize
  // ----------------------------
  function createFilterRow(initialFieldValue) {
    const rowId = `filterRow_${filterRowCounter++}`;

    const $row = $(`
      <div class="form-row align-items-center mb-2 filter-row" data-row-id="${rowId}">
        <div class="col-12 col-md-4 mb-2 mb-md-0">
          <select class="form-control filter-field"></select>
        </div>
        <div class="col-12 col-md-7 mb-2 mb-md-0">
          <select class="form-control filter-value" placeholder="Value"></select>
        </div>
        <div class="col-12 col-md-1">
          <button type="button" class="btn btn-outline-danger btn-block remove-filter" title="Remove">×</button>
        </div>
      </div>
    `);

    $("#filtersContainer").append($row);

    // Populate field options
    const $fieldSelect = $row.find(".filter-field");
    FILTER_FIELDS.forEach((f) => $fieldSelect.append(`<option value="${f.value}">${f.label}</option>`));

    // Initialize selectize for field
    $fieldSelect.selectize({
      maxItems: 1,
      create: false,
      onChange: function (value) {
        // Reset the value select when field changes
        const valueSelectize = $row.find(".filter-value")[0].selectize;
        valueSelectize.clear(true);
        valueSelectize.clearOptions();

        // If "q" (global search), no column suggestions
        if (!value || value === "q") return;

        // Load suggestions for that column (if your backend supports it)
        const columnName = PARAM_TO_COLUMN[value] || value;
        $.ajax({
          url: "/api/search/column/" + columnName,
          type: "GET",
          contentType: "json",
        })
          .then((response) => {
            valueSelectize.load(function (callback) {
              callback(response);
            });
          })
          .catch((err) => {
            // non-fatal; user can still type
            console.log(err);
          });
      },
    });

    // Initialize selectize for value
    $row.find(".filter-value").selectize({
      maxItems: 1,
      create: true,
      labelField: "value",
      valueField: "value",
      searchField: "value",
      render: {
        option: function (item, escape) {
          return "<div>" + escape(item.value) + "</div>";
        },
      },
      onChange: function (value) {},
    });

    // Set initial field value if provided
    const fieldSelectize = $fieldSelect[0].selectize;
    fieldSelectize.setValue(initialFieldValue || "q", true);

    // Remove handler
    $row.find(".remove-filter").on("click", () => {
      // Do not allow removing the last row
      if ($(".filter-row").length <= 1) return;

      // Destroy selectize instances cleanly
      $row.find(".filter-field")[0].selectize.destroy();
      $row.find(".filter-value")[0].selectize.destroy();
      $row.remove();
    });
  }

  function clearFilters() {
    // Destroy all rows, recreate one
    $(".filter-row").each(function () {
      const $r = $(this);
      try {
        $r.find(".filter-field")[0].selectize.destroy();
        $r.find(".filter-value")[0].selectize.destroy();
      } catch (e) {}
      $r.remove();
    });
    createFilterRow("q");
    $("#resultsDiv").empty();
    $("#searchInfo").text("");
  }

  // ----------------------------
  // Collect filters -> call new endpoint
  // ----------------------------
  function collectFilters() {
    // Aggregate by param, because backend (as written) expects comma-separated values per param.
    // Example: make=Honda,Toyota
    const map = {}; // param -> array of values

    const keywordsForHighlight = [];

    $(".filter-row").each(function () {
      const $row = $(this);
      const field = $row.find(".filter-field")[0].selectize.getValue().trim();
      const value = $row.find(".filter-value")[0].selectize.getValue().trim();

      if (!field || !value) return;

      if (!map[field]) map[field] = [];
      map[field].push(value);

      keywordsForHighlight.push(value);
    });

    // De-dupe values per field
    for (const k of Object.keys(map)) {
      map[k] = Array.from(new Set(map[k]));
    }

    return { filterMap: map, highlightKeywords: keywordsForHighlight };
  }

  function buildApiUrl(filterMap) {
    const params = new URLSearchParams();

    // General options
    params.set("matchMode", $("#matchMode").val());
    params.set("sortBy", $("#sortBy").val());
    params.set("sortDir", $("#sortDir").val());
    params.set("limit", $("#limit").val());
    params.set("offset", "0");

    // Filters
    // If multiple entries per key, join as comma-separated (backend supports that)
    for (const [key, values] of Object.entries(filterMap)) {
      params.set(key, values.join(","));
    }

    return `/api/vehicles/search?${params.toString()}`;
  }

  function loadVehicleData(e) {
    if (e) e.preventDefault();

    const { filterMap, highlightKeywords } = collectFilters();

    // Require at least one valid filter
    const hasAny = Object.keys(filterMap).length > 0;
    if (!hasAny) {
      $("#searchInfo").text("Add at least one filter value before searching.");
      return;
    }

    $("#spinner").removeAttr("hidden");

    const apiUrl = buildApiUrl(filterMap);

    fetch(apiUrl)
      .then((r) => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      })
      .then((res) => {
        $("#resultsDiv").empty();

        res.results.forEach((vehicle) => {
          const highlightedObj = highlighter(vehicle, highlightKeywords);
          $("#resultsDiv").append(appendHTML(highlightedObj));
        });

        $("#searchInfo").text(
          `Showing ${res.rowCount}${res.rowCount === 1 ? " result" : " results"} (${res.processingTime})`
        );
      })
      .catch((err) => {
        console.log(err);
        $("#searchInfo").text("Search failed. Please try again.");
      })
      .finally(() => {
        $("#spinner").attr("hidden", true);
      });
  }

  // ----------------------------
  // Wire up UI events
  // ----------------------------
  $("#goSearch").click((e) => loadVehicleData(e));

  $("#addFilterBtn").click(() => {
    createFilterRow("make"); // default field for new rows; adjust as you prefer
  });

  $("#clearFilters").click(() => clearFilters());

  // Submit on Enter (avoid accidental submits from selectize inputs)
  $(document).keypress(function (e) {
    const keycode = e.keyCode ? e.keyCode : e.which;
    if (keycode == 13) {
      // If focus is within form, run search
      if ($(e.target).closest("#vehicleSearchForm").length > 0) {
        loadVehicleData(e);
      }
    }
  });

  // Prevent actual form submit reload
  $("#vehicleSearchForm").on("submit", function (e) {
    e.preventDefault();
    loadVehicleData(e);
  });

  // ----------------------------
  // Init
  // ----------------------------
  $(function () {
    // Start with two rows: global q + a common filter (optional)
    createFilterRow("q");
    // Uncomment if you want a second filter row by default:
    // createFilterRow("make");
  });
</script>
